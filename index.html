<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VimTractor - Learn Vim by Playing</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="A fun arcade game to learn Vim commands while driving a tractor through fields">
    <meta name="theme-color" content="#2a2a2a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="VimTractor">

    <!-- Favicon and Icons -->
    <link rel="icon" href="/icons/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icons/icon.svg">
    <link rel="manifest" href="/manifest.json">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div id="game-container">
        <canvas id="game-canvas"></canvas>
        <div id="hud">
            <div class="hud-left">
                <div id="score">Score: <span id="score-value">0</span></div>
            </div>
            <div class="hud-center">
                <div id="level-indicator">
                    <span id="speed-level">Lv.1</span>
                </div>
            </div>
            <div class="hud-right">
                <div id="high-score"><span id="high-score-value">0</span></div>
                <div id="hud-items">
                    <span id="lives-indicator" class="hud-item" title="Lives remaining">üöú<span id="lives-count" class="item-count">3</span></span>
                    <span id="powerup-gas" class="hud-item hidden" title="dd: pulisci riga (2) / dG: pulisci schermo (10)">‚õΩ<span id="gas-count" class="item-count">0</span></span>
                </div>
            </div>
        </div>
        <!-- Sidebar for controls -->
        <div id="dev-sidebar">
            <span id="theme-toggle" class="sidebar-btn" title="Drabda mode OFF (:drabda)">DR</span>
            <span id="debug-toggle" class="sidebar-btn" title="Debug Mode: OFF - Click to pause scroll">üêõ</span>
            <span id="sound-toggle" class="sidebar-btn" title="Sound ON">üîä</span>
            <span id="help-toggle" class="sidebar-btn" title="Help (:help)">?</span>
        </div>
        <div id="overlay" class="hidden">
            <div id="name-screen" class="screen">
                <h1>VimTractor</h1>
                <p class="subtitle">Learn Vim commands by playing!</p>
                <div class="name-input-container">
                    <label for="player-name">Enter your name:</label>
                    <input type="text" id="player-name" maxlength="12" placeholder="Your name" autocomplete="off">
                    <p class="name-hint">Press <kbd>Enter</kbd> to continue</p>
                </div>
            </div>
            <div id="menu-screen" class="screen hidden">
                <div class="menu-content">
                    <h1>VimTractor</h1>
                    <p class="subtitle">Welcome, <span id="player-display-name"></span>!</p>
                    <p id="slogan" class="slogan-typewriter"></p>
                    <p class="start-prompt">Press any key to start</p>
                </div>
                <p id="drabda-message" class="drabda-message hidden">(complimenti per aver scelto DRABDA mode)</p>
                <div class="menu-footer">
                    <span><kbd>Tab</kbd> Leaderboard</span>
                    <span><kbd>?</kbd> Help</span>
                    <span><kbd>:q</kbd> Exit</span>
                </div>
            </div>
            <div id="leaderboard-screen" class="screen hidden">
                <h1>Leaderboard</h1>
                <div id="leaderboard-list" class="leaderboard-container">
                    <!-- Populated dynamically -->
                </div>
                <p class="help-footer">Press <kbd>Esc</kbd> to go back</p>
            </div>
            <div id="gameover-screen" class="screen hidden">
                <h1>Game Over</h1>
                <p>Score: <span id="final-score">0</span></p>
                <p>High Score: <span id="final-high-score">0</span></p>
                <p class="start-prompt">Press Enter to continue</p>
                <p class="leaderboard-hint">Press <kbd>Tab</kbd> for leaderboard</p>
            </div>
            <div id="help-screen" class="screen hidden">
                <div class="help-tabs">
                    <button class="help-tab active" data-tab="commands">Commands</button>
                    <button class="help-tab" data-tab="howtoplay">How to Play</button>
                </div>

                <div class="help-tab-content active" data-content="commands">
                    <div class="help-content">
                        <div class="help-section">
                            <h3>Navigation (no collection)</h3>
                            <div class="help-row"><kbd>h/j/k/l</kbd> <span>Move left/down/up/right</span></div>
                            <div class="help-row"><kbd>w</kbd> <span>Jump to next word start</span></div>
                            <div class="help-row"><kbd>b</kbd> <span>Jump to previous word start</span></div>
                            <div class="help-row"><kbd>e</kbd> <span>Jump to word end</span></div>
                            <div class="help-row"><kbd>ge</kbd> <span>Jump to previous word end</span></div>
                            <div class="help-row"><kbd>0 / $</kbd> <span>Go to row start / end</span></div>
                            <div class="help-row"><kbd>gg / G</kbd> <span>Go to screen top / bottom</span></div>
                        </div>
                        <div class="help-section">
                            <h3>Delete = Collect</h3>
                            <div class="help-row"><kbd>x</kbd> <span>Collect cell (Nx = N cells)</span> <span class="cost">free</span></div>
                            <div class="help-row"><kbd>dw</kbd> <span>Collect to next word</span> <span class="cost">free</span></div>
                            <div class="help-row"><kbd>de</kbd> <span>Collect to word end</span> <span class="cost">free</span></div>
                            <div class="help-row"><kbd>db</kbd> <span>Collect backward to word</span> <span class="cost">free</span></div>
                            <div class="help-row"><kbd>d0</kbd> <span>Collect to row start</span> <span class="cost">free</span></div>
                            <div class="help-row"><kbd>d$</kbd> <span>Collect to row end</span> <span class="cost">free</span></div>
                            <div class="help-row"><kbd>dd</kbd> <span>Collect entire row</span> <span class="cost">2 gas</span></div>
                            <div class="help-row"><kbd>dG</kbd> <span>Collect entire screen</span> <span class="cost">10 gas (20%)</span></div>
                        </div>
                        <div class="help-section">
                            <h3>Change = Collect + Plant Seeds</h3>
                            <div class="help-row"><kbd>cw</kbd> <span>Collect + plant to next word</span> <span class="cost">free</span></div>
                            <div class="help-row"><kbd>ce</kbd> <span>Collect + plant to word end</span> <span class="cost">free</span></div>
                            <div class="help-row"><kbd>cb</kbd> <span>Collect + plant backward</span> <span class="cost">free</span></div>
                            <div class="help-row"><kbd>cc</kbd> <span>Collect + plant entire row</span> <span class="cost">3 gas</span></div>
                            <p class="help-tip">Seeds grow into vegetables after 3 seconds!</p>
                        </div>
                        <div class="help-section">
                            <h3>Command Mode</h3>
                            <div class="help-row"><kbd>:</kbd> <span>Enter command mode</span></div>
                            <div class="help-row"><kbd>:q</kbd> <span>Quit game</span></div>
                            <div class="help-row"><kbd>:restart</kbd> <span>Restart game</span></div>
                        </div>
                    </div>
                </div>

                <div class="help-tab-content" data-content="howtoplay">
                    <div class="help-content tutorial">
                        <div class="tutorial-section">
                            <h3>Goal</h3>
                            <p>Collect vegetables using Vim commands while avoiding rocks. The screen scrolls upward - don't fall off!</p>
                        </div>
                        <div class="tutorial-section">
                            <h3>Movement vs Collection</h3>
                            <p>In VimTractor, movement and collection are separate:</p>
                            <ul>
                                <li><strong>Movement (h/j/k/l/w/b)</strong> - navigate without collecting</li>
                                <li><strong>Delete (x/dw/de/dd)</strong> - collect items for points</li>
                                <li><strong>Change (cw/ce/cc)</strong> - collect AND plant seeds</li>
                            </ul>
                        </div>
                        <div class="tutorial-section">
                            <h3>Seeds</h3>
                            <p>Use change commands to plant seeds. Seeds grow into vegetables after 3 seconds - come back later to collect them!</p>
                        </div>
                        <div class="tutorial-section">
                            <h3>Gas Cans</h3>
                            <p>Collect gas cans to power special moves:</p>
                            <ul>
                                <li><strong>dd</strong> - Clear entire row (2 gas)</li>
                                <li><strong>cc</strong> - Clear row + plant seeds (3 gas)</li>
                                <li><strong>dG</strong> - Clear screen (10 gas, 20% points)</li>
                            </ul>
                        </div>
                        <div class="tutorial-section">
                            <h3>Lives</h3>
                            <p>You start with 3 lives. Lose one by hitting rocks or falling off screen. Collect extra tractors for more lives!</p>
                        </div>
                    </div>
                </div>

                <p class="help-footer">Press <kbd>?</kbd> or <kbd>Esc</kbd> to close</p>
                <p class="version-info" id="version-info"></p>
            </div>
        </div>
        <div id="vim-statusline">
            <span id="mode-indicator">NORMAL</span>
            <span id="command-line"><span id="command-prefix"></span><span id="command-buffer"></span><span id="cursor">_</span></span>
            <span id="statusline-hint">:help</span>
        </div>
        <div id="vim-infobar">
            <div class="infobar-left">
                <span id="infobar-player">Player</span>
                <span class="infobar-separator">‚îÇ</span>
                <span id="infobar-time">0:00</span>
            </div>
            <div class="infobar-right">
                <span id="infobar-position">0:0</span>
            </div>
        </div>
    </div>

    <script type="module" src="/src/main.js"></script>

    <!-- Service Worker Registration with Auto-Reload -->
    <script>
        if ('serviceWorker' in navigator) {
            // Flag to track pending update
            let updatePending = false;

            // Function to safely reload when not playing
            function safeReload() {
                const game = window.vimtractorGame;
                const isPlaying = game && game.state === 'PLAYING';

                if (!isPlaying) {
                    console.log('[SW] Reloading for update...');
                    window.location.reload();
                } else {
                    console.log('[SW] Update pending - waiting for game to end');
                    updatePending = true;
                }
            }

            // Listen for game state changes to apply pending updates
            window.addEventListener('vimtractor:statechange', (e) => {
                if (updatePending && e.detail.state !== 'PLAYING') {
                    console.log('[SW] Game ended - applying pending update');
                    window.location.reload();
                }
            });

            // Listen for reload message from SW (works even with old HTML)
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'RELOAD_FOR_UPDATE') {
                    console.log('[SW] Received reload request for version:', event.data.version);
                    safeReload();
                }
            });

            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('VimTractor SW registered:', registration.scope);

                        // Check for updates every 60 seconds
                        setInterval(() => registration.update(), 60000);

                        // Handle new service worker installation
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('[SW] Update found, installing...');

                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed') {
                                    if (navigator.serviceWorker.controller) {
                                        // New version available
                                        console.log('[SW] New version ready');
                                        newWorker.postMessage('skipWaiting');
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('VimTractor SW registration failed:', error);
                    });

                // Reload when new SW takes control
                let refreshing = false;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (!refreshing) {
                        refreshing = true;
                        safeReload();
                    }
                });
            });
        }
    </script>
</body>
</html>
